version: "3.7"
services:
    dashboard:
        image: phpmate
        volumes:
            - .:/var/www
        working_dir: /var/www
        depends_on:
            - composer
            - postgres
        ports:
            - 8080:8080
        entrypoint: [ "bash", "/docker-entrypoint.sh" ]
        command: [ "php", "-S", "0.0.0.0:8080", "-t", "public" ]

    js-watch:
        image: node:14
        volumes:
            - .:/var/www
        working_dir: /var/www
        restart: unless-stopped
        entrypoint: [""]
        command: "bash -c 'yarn install && yarn run watch'"

    postgres:
        # alpine is forbidden => https://stackoverflow.com/questions/58135353/postgres-seems-to-be-ignoring-my-default-collation
        image: postgres:13
        environment:
            POSTGRES_USER: phpmate
            POSTGRES_PASSWORD: phpmate
        volumes:
            - .docker-data/postgres:/var/lib/postgresql/data
        ports:
            - "${PHPMATE_POSTGRES_PORT:-5432}:5432"

    # Helper service
    composer:
        image: phpmate
        build:
            context: .
            target: dev
        volumes:
            - .:/var/www
        working_dir: /var/www
        entrypoint: "composer"
        command: [ "install", "--no-interaction" ]

    worker:
        image: phpmate
        volumes:
            - .:/var/www
        working_dir: /var/www
        depends_on:
            - dashboard
        command: [ "wait-for-it", "dashboard:8080", "--", "bin/worker" ]

    scheduler:
        image: phpmate
        volumes:
            - .:/var/www
        working_dir: /var/www
        depends_on:
            - dashboard
        command: [ "wait-for-it", "dashboard:8080", "--", "bin/scheduler" ]

    adminer:
        image: adminer:4.8.0
        ports:
            - 8000:8080
        depends_on:
            - postgres

###> symfony/mercure-bundle ###
  mercure:
    image: dunglas/mercure
    restart: unless-stopped
    environment:
      SERVER_NAME: ':80'
      MERCURE_PUBLISHER_JWT_KEY: '!ChangeMe!'
      MERCURE_SUBSCRIBER_JWT_KEY: '!ChangeMe!'
      # Set the URL of your Symfony project (without trailing slash!) as value of the cors_origins directive
      MERCURE_EXTRA_DIRECTIVES: |
        cors_origins http://127.0.0.1:8000
    # Comment the following line to disable the development mode
    command: /usr/bin/caddy run -config /etc/caddy/Caddyfile.dev
    volumes:
      - mercure_data:/data
      - mercure_config:/config
###< symfony/mercure-bundle ###

volumes:
###> symfony/mercure-bundle ###
  mercure_data:
  mercure_config:
###< symfony/mercure-bundle ###
